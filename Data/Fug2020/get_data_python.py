
import math
import pickle
import copy
import os
import mne
import scipy.io
import librosa
from scipy.signal import butter, sosfiltfilt, filtfilt, hilbert
import scipy.io as scio
# basic settings
import numpy as np
import glob

gammatone_a = np.array([[1.00000000000000000000,-7.78419636070708875764,26.51559563418723897144,-51.62340476146648171607,62.83007561391077899771,-48.95129042198091440241,23.84165438485330668072,-6.63691542998415862087,0.80848134121027537269,],
                        [1.00000000000000000000,-7.72081918221068264074,26.11021259864061505596,-50.51533190843820619875,61.15314678267773729203,-47.43477161274710596217,23.02277208079706838362,-6.39269803717422036016,0.77748928448596310581,],
                        [1.00000000000000000000,-7.62027037872892609727,25.48812810740221834749,-48.87342088673989337622,58.76040426839489327904,-45.35982348797413976627,21.95508769527918957465,-6.09208891513343431257,0.74198387932331588690,],
                        [1.00000000000000000000,-7.46603021342994654930,24.56384820964221660233,-46.50896023794460631962,55.42308046324477999178,-42.56436706468637964917,20.57384689835616242704,-5.72292943594563130461,0.70151699590210125912,],
                        [1.00000000000000000000,-7.23507113757600972548,23.22928561146039783125,-43.20220919127937975190,50.89035042924601981440,-38.87594238532992108048,18.80987036479069018924,-5.27190685647234058564,0.65569201867788873273,],
                        [1.00000000000000000000,-6.89574022480522863532,21.35833455301095895607,-38.73281181743524115291,44.93925340447856342507,-34.14899739249655397089,16.60218496685652311839,-4.72582556303507672624,0.60422087612012520541,],
                        [1.00000000000000000000,-6.40544120407010986185,18.82612608363597317407,-32.95184884806408831537,37.47762853926195703025,-28.33856695610877807212,13.92378019765202523672,-4.07420936746531570094,0.54700638005434576439,],
                        [1.00000000000000000000,-5.70879092455146253116,15.55814963465048350599,-25.91497335513576416588,28.71429889166465443395,-21.61820243545859909773,10.82668669964013119511,-3.31398528677416415178,0.48425626789174613940,],
                        [1.00000000000000000000,-4.73801270719318168290,11.63193544019085479135,-18.06738977601743911805,19.36807834501986747000,-14.51556130099396391131,7.50807882825522732162,-2.45703578682252077314,0.41663301468827029783,],
                        [1.00000000000000000000,-3.41962976547182373466,7.45176245290437222479,-10.36417379155694540316,10.78433681196167093219,-7.94559551514382800264,4.37968155050898921843,-1.54082879644466563818,0.34543557647369044217,],
                        [1.00000000000000000000,-1.69599201435620283718,3.96944003375513254639,-3.98196868704945394768,4.72514951577888098200,-2.87776298778462003014,2.07321150206972681929,-0.64017004590654102980,0.27279017745880695944,],
                        [1.00000000000000000000,0.42236129305598713035,2.74781843110613221981,0.85394747036270424179,2.78505027796718795940,0.57234175380297003244,1.23434504911194653509,0.12716187752987306858,0.20178881706321852296,],
                        [1.00000000000000000000,2.74938581775087120818,5.26576929179664965375,6.31195459017331828022,5.88522614197782800716,3.83624567819858519613,1.94512233322765792920,0.61725316755094461474,0.13644894607894733629,],
                        [1.00000000000000000000,4.74616456174822509695,10.58308991960705469637,14.28471120394442017698,12.71365294833850967393,7.62735958720720930160,3.01729657476795853910,0.72252197878560731059,0.08128511551021080916,],
                        [1.00000000000000000000,5.35415348986103367679,12.54179482193359973508,16.78767362874420854268,14.04434083531075572182,7.51955564961769074017,2.51630344522530080553,0.48116695974294243499,0.04025377744864842844,],])
gammatone_b = np.array([[-0.00000010597652766177,0.00000003676155562584,0.00000086187512926402,-0.00000163671969713874,0.00000097284465896998,-0.00000003066590170516,-0.00000009811921735417,],
                        [-0.00000031338689553687,-0.00000002997743395041,0.00000271796665780883,-0.00000452409753587552,0.00000233788289165715,0.00000006051612821006,-0.00000024890381231324,],
                        [-0.00000056075753214079,-0.00000031003694134841,0.00000521633898728694,-0.00000752111333417452,0.00000312021116792610,0.00000041998179630994,-0.00000036462414385926,],
                        [-0.00000104200879624161,-0.00000109858841516419,0.00001050940939111329,-0.00001281979338924437,0.00000349689034730683,0.00000146094709341474,-0.00000050685623118468,],
                        [-0.00000204576902107327,-0.00000308651698789918,0.00002240450371767588,-0.00002300334895122765,0.00000215813565211096,0.00000422707442096504,-0.00000065407883055178,],
                        [-0.00000419695220381267,-0.00000766795153290136,0.00004971203356096922,-0.00004341095025270247,-0.00000491109594818099,0.00001116200428911087,-0.00000068708791248259,],
                        [-0.00000888869903108000,-0.00001712902543873818,0.00011318368862392796,-0.00008589636188466982,-0.00002868702787356526,0.00002765697903550699,-0.00000023955343138168,],
                        [-0.00001921812497691472,-0.00003321327676582300,0.00026134705756440955,-0.00017735085880695020,-0.00009781322973411700,0.00006458922468989716,0.00000165920802949827,],
                        [-0.00004192939783240506,-0.00004797438969142918,0.00060440637715017062,-0.00037854614713175275,-0.00028386453643472611,0.00014056563842815780,0.00000734245551198458,],
                        [-0.00009095649341405690,-0.00000713827743381128,0.00137495579511497405,-0.00082087099494110793,-0.00075416863502853707,0.00027628231160973084,0.00002189629409280842,],
                        [-0.00019162613519872857,0.00030152869412731830,0.00298474455921088821,-0.00175483853169588143,-0.00185107009053455339,0.00045627329850066645,0.00005498820559029051,],
                        [-0.00037481271565188961,0.00147125933518354231,0.00586032021490475244,-0.00351260588959958434,-0.00407856386932984108,0.00051377215303764171,0.00012063077145537810,],
                        [-0.00061319962102325673,0.00441219680562832811,0.00945328579849128055,-0.00598383391913932545,-0.00748552490318576177,-0.00000711581068491844,0.00022419164991364687,],
                        [-0.00061141119231098264,0.00777329761457448438,0.01026049517261534705,-0.00697527152263500202,-0.00947668888839332639,-0.00126949253582630227,0.00029907135197577734,],
                        [0.00010503004746242801,0.00179587957542515935,0.00107900187220983496,-0.00211259955656618566,-0.00207394286980641359,-0.00036031349794920164,0.00006972551861462659,],])

if __name__ == '__main__':

    
    sos = butter(5, [1,9], 'bp', fs=128, output='sos')
    # dataset_path = {'KUL':[], 'DTU':[], 'DS':[]}
    dataset_path = {'Fug2020':[]}

    for key in dataset_path.keys():
        all_files = glob.glob(f'preprocessed/S***preprocessed.mat')
        dataset_path[key] = all_files


    

    for key in dataset_path.keys():
        all_files = dataset_path[key]


        for each in all_files:
            print(each)
            data = scio.loadmat(each)
            target_path = each[0:-16] + 'preprocessed_py.pkl'
            num_trials = len(data['Trials'][0, 0][3][0])
            Trials = {}
            Trials['eeg'] = []
            Trials['envelope_subband'] = []
            Trials['envelope_fullband'] = []
            Trials['wav'] = []
            Trials['target_direction'] = []
            Trials['target_gender'] = []
            Trials['wavelet'] = []
            Trials['wavelet_ref'] = []

            for i_trial in range(num_trials):


                eeg = data['Trials'][0, 0][0][0, i_trial].astype(np.float32)
                wav =data['Trials'][0, 0][2][0, i_trial].astype(np.float32)


                env_multi_band = []
                for i_subband in range(len(gammatone_a)):

                    env_subband = filtfilt(gammatone_b[i_subband], gammatone_a[i_subband], wav.copy(), axis=0)
                    env_subband = np.abs(hilbert(env_subband)) ** 0.3
                    env_subband = librosa.resample(env_subband.T, axis=-1, orig_sr=8000, target_sr=128).T
                    env_subband = sosfiltfilt(sos, env_subband, axis=0)
                    env_multi_band.append(env_subband)

                env_multi_band = np.stack(env_multi_band, 0)
                # print(env_multi_band.shape)
                env_multi_band = np.mean(env_multi_band, 0).astype(np.float32)


                env_fullband = np.abs(hilbert(wav)) ** 0.3
                env_fullband = librosa.resample(env_fullband.T, axis=-1, orig_sr=8000, target_sr=128).T
                env_fullband = sosfiltfilt(sos, env_fullband, axis=0).astype(np.float32)

                target_direction = int(data['Trials'][0, 0][3][0, i_trial])
                target_gender = 0 if key == 'KUL' else int(data['Trials'][0, 0][4][0, i_trial])
                wavelet = data['Trials'][0, 0][5][0, i_trial].astype(np.float32)[:, 0:-1, :]    # (channel, time, frequency)

                wavelet_ref = data['Trials'][0, 0][6][0, i_trial].astype(np.float32)[:, 0:-1, :]  if len(data['Trials'][0, 0]) > 5 else wavelet

                print(f'trial:{i_trial+1}, TarGen: {target_gender}, TarDir:{target_direction}, len_eeg:{len(eeg)/128}, len_wav:{len(wav)/8000}, len_env: {len(env_fullband)/128}, len_wavelet:{wavelet.shape[1]/10}')

                Trials['eeg'].append(eeg)
                Trials['envelope_subband'].append(env_multi_band)
                Trials['envelope_fullband'].append(env_fullband)
                Trials['wav'].append(wav)
                Trials['target_direction'].append(target_direction)
                Trials['target_gender'].append(target_gender)
                Trials['wavelet'].append(wavelet)
                Trials['wavelet_ref'].append(wavelet_ref)
            with open(target_path, 'wb') as f:
                 pickle.dump(Trials, f)
            # np.save(target_path, Trials)







